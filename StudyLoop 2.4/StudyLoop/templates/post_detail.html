{% extends "base.html" %}
{% block content %}

<a href="{{ url_for('index') }}" class="meta" style="text-decoration:none;">← Back to feed</a>

<article class="card" style="border-left:4px solid #457b9d;">
  <h2 style="margin:.25rem 0 0.5rem;">{{ post["title"] }}</h2>
  <p class="meta">
    <strong>Course:</strong> {{ post["course"] }} •
    <strong>Tags:</strong> {{ post["tags"] }}
  </p>
  <p style="margin-top:.5rem;">{{ post["prompt"] }}</p>
  {% if ttr is not none %}
    <p class="meta" title="Minutes from post to first reply">⏱️ Time to first reply: {{ ttr }} min</p>
  {% endif %}
</article>

<section aria-labelledby="replies-heading">
  <div class="card" style="background:#f8fafc;border-color:#e2e8f0;">
    <h3 id="replies-heading" style="margin:.25rem 0 1rem;">Replies</h3>

    {% for r in replies %}
      <div class="reply card" style="border:1px dashed #d1d5db;">
        <!-- Uploaded video -->
        <div class="reply-video" style="margin:.25rem 0 1rem;">
          <video controls playsinline style="width:100%;aspect-ratio:16/9;height:auto;border-radius:8px;outline:none;">
            <source src="{{ url_for('uploaded_file', filename=r['video_path']) }}">
            Your browser does not support the video tag.
          </video>
        </div>

        <p class="transcript" style="line-height:1.5;">
          <strong>Transcript:</strong>
          {% if r["transcript"] and r["transcript"]|trim %}
            {{ r["transcript"] }}
          {% else %}
            <em>(No transcript provided)</em>
          {% endif %}
        </p>

        <div class="meta" style="display:flex;flex-wrap:wrap;gap:.5rem;align-items:center;margin-top:.5rem;">
          <span title="Sum of Clear + Correct + Concise">Q-score: <strong>{{ r['qscore'] or 0 }}</strong></span>
          <span>• Upvotes: <strong>{{ r['upvotes'] }}</strong></span>
          <span>• Flags: <strong>{{ r['flags'] }}</strong></span>
        </div>

        <div style="display:flex;gap:.5rem;margin-top:.5rem;flex-wrap:wrap;">
            {% set dims = ["clear", "correct", "concise"] %}
            {% for dim in dims %}
            {% set voted = (r['id'] ~ '_' ~ dim) in user_votes %}
            <form method="post" action="{{ url_for('rate_reply', reply_id=r['id']) }}" class="inline">
                <button name="dim" value="{{ dim }}"
                        style="background:{{ '#1d3557' if voted else '#f1f5f9' }};color:{{ 'white' if voted else '#111' }};"
                        aria-label="Toggle vote for {{ dim }}">
                    {{ '✓' if voted else '+' }} {{ dim.capitalize() }} ({{ r[dim] }})
                </button>
            </form>
            {% endfor %}

            {% set reported = r['id'] in user_reports %}
            <form method="post" action="{{ url_for('report_reply', reply_id=r['id']) }}" class="inline" style="margin-left:auto;">
                <button class="danger"
                        style="background:{{ '#dc2626' if reported else '#fee2e2' }};color:{{ 'white' if reported else '#b91c1c' }};"
                        aria-label="Toggle report">
                    {{ '⚠️ Reported' if reported else 'Report' }} ({{ r['flags'] }})
                </button>
            </form>
        </div>
      </div>
    {% else %}
      <p class="meta" style="margin:0;">No replies yet — be the first!</p>
    {% endfor %}
  </div>
</section>

<section class="card" aria-labelledby="add-reply-heading" style="border-left:4px solid #1d3557;">
  <h3 id="add-reply-heading" style="margin:.25rem 0 1rem;">Add Your 60–90s Reply</h3>
  <p class="meta" style="margin-top:-.5rem;">Accepted: mp4, webm, ogg, ogv, m4v, mov • Max ~200&nbsp;MB</p>

  <!-- Live preview renders here after file selection -->
  <div id="reply-preview" style="margin:.5rem 0;"></div>

  <form method="post"
        action="{{ url_for('add_reply', post_id=post['id']) }}"
        class="form"
        enctype="multipart/form-data"
        id="reply-form">
    <label>Upload Video (required)
      <input type="file" name="video_file" id="video_file"
             accept=".mp4,.webm,.ogg,.ogv,.m4v,.mov,video/*" required>
    </label>
    <label>Transcript (required)
      <textarea name="transcript" rows="4" required
                placeholder="Summarize your explanation in a few sentences so others can scan quickly."></textarea>
    </label>
    <button type="submit" id="submit-btn">Submit Reply</button>
  </form>

  <p class="meta" style="margin-top:.5rem;">
    <strong>Legend:</strong>
    <em>Upvotes</em> = overall helpful •
    <em>Clear/Correct/Concise</em> = quality dimensions that add to Q-score.
  </p>
</section>

<!-- File preview + double-submit guard -->
<script>
(function () {
  const input   = document.getElementById('video_file');
  const preview = document.getElementById('reply-preview');
  const form    = document.getElementById('reply-form');
  const submit  = document.getElementById('submit-btn');

  if (input) {
    input.addEventListener('change', function () {
      preview.innerHTML = '';
      const file = this.files && this.files[0];
      if (!file) return;

      const url = URL.createObjectURL(file);
      const video = document.createElement('video');
      video.controls = true;
      video.playsInline = true;
      video.style.width = '100%';
      video.style.aspectRatio = '16/9';
      video.style.borderRadius = '8px';
      video.src = url;
      preview.appendChild(video);
    });
  }

  if (form && submit) {
    form.addEventListener('submit', function () {
      submit.disabled = true;
      submit.textContent = 'Uploading…';
    });
  }
})();
</script>

{% endblock %}
